{ pkgs }:
let
  lib = pkgs.lib;

  testScript = ''
    import os

    # Read credentials from host environment at runtime
    depot_user = os.getenv("DEPOT_USER")
    depot_token = os.getenv("DEPOT_TOKEN")

    if not depot_user or not depot_token:
        raise Exception("DEPOT_USER and DEPOT_TOKEN environment variables must be set")

    # wait for system to boot up
    vm.wait_for_unit("multi-user.target")

    # setup credentials
    vm.succeed("/sbin/useradd --uid 1000 --comment CIQ --user-group ciq --groups systemd-journal,wheel")
    vm.succeed("echo -e 'rockylinux\nrockylinux' | passwd ciq")
    vm.succeed("echo -e 'rockylinux\nrockylinux' | passwd root")

    # setup cups
    vm.succeed("dnf install --assumeyes cups", timeout=600)
    vm.systemctl("enable --now cups.service")

    # make cups vulnerable
    vm.succeed("sed -i 's/.*DefaultAuthType.*/DefaultAuthType Negotiate/g' /etc/cups/cupsd.conf")

    # first auth attempt using **incorrect** credentials
    # i.e. **MUST FAIL**
    # i.e. not vulnerable to an incorrect credential
    first_curl_attempt = vm.execute('curl -w "%{http_code}" -s -o /dev/null -H "Authorization: Basic $(echo -n root:incorrectp | base64)" http://localhost:631/admin/log 2>/dev/null')
    # 0th field is the return code, 1st field is the command's output
    assert "401" in first_curl_attempt[1]

    # second auth attempt using **correct** credentials, but **incorrect** auth method
    # i.e. **WILL PASS**
    # i.e. we are vulnerable to correct credentials but incorrect auth method
    second_curl_attempt = vm.execute('curl -w "%{http_code}" -s -o /dev/null -H "Authorization: Basic $(echo -n root:rockylinux | base64)" http://localhost:631/admin/log 2>/dev/null')
    assert "200" in second_curl_attempt[1]

    # configure repositories providing LTS support from CIQ
    vm.succeed('dnf install -y https://depot.ciq.com/public/files/depot-client/depot/depot."$(uname -m)".rpm')
    # use the `.execute()` to prevent the command (with the credentials) from getting logged
    depot_login = vm.execute(f'depot login --user "{depot_user}" --token "{depot_token}"', timeout=60)
    if depot_login[0] != 0:
        print('ERROR: Could not log in using the provided Depot credentials')
    vm.succeed("export $(cat /etc/os-release | grep '^VERSION_ID=' | sed -e 's/\"//g') && depot enable \"lts-''${VERSION_ID}\"")
    vm.succeed("dnf clean all")

    # update to the patched version from CIQ
    vm.succeed("dnf upgrade --assumeyes cups", timeout=600)
    vm.systemctl("restart cups.service")

    # third auth attempt, same as second auth attempt
    # i.e. **MUST FAIL**
    third_curl_attempt = vm.execute('curl -w "%{http_code}" -s -o /dev/null -H "Authorization: Basic $(echo -n root:rockylinux | base64)" http://localhost:631/admin/log 2>/dev/null')
    print(third_curl_attempt[1])
    assert "401" in third_curl_attempt[1]

    vm.shutdown()
  '';
in

{
  rlc_8_6_cve_2025-58060 = (pkgs.testers.nonNixOSDistros.rocky."8_6" {
    inherit testScript;
  }).driver;

  rlc_9_2_cve_2025-58060 = (pkgs.testers.nonNixOSDistros.rocky."9_2" {
    inherit testScript;
  }).driver;

  rlc_9_4_cve_2025-58060 = (pkgs.testers.nonNixOSDistros.rocky."9_4" {
    inherit testScript;
  }).driver;
}
